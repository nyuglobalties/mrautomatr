---
title: "`r params$set_title`"
author: "`r params$set_author`"
date: "`r Sys.Date()`"
params:
  printcode: no
  printwarning: no
  storecache: yes
  set_title: "Lebanon Year 1 (2016-2017) Measurement Report"
  set_author: "Michael Wu"
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
    reference_docx: "MR_word_template.docx"
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = TRUE, 
                      fig.cap = TRUE,
                      echo = params$printcode, 
                      warning = params$printwarning, 
                      cache = params$storecache,
                      message = F,
                      error = T,
                      results="asis")
library(officedown)
library(officer)
library(tidyverse)
library(psych)
library(MplusAutomation)
library(gridExtra)
library(semPlot)
library(kableExtra)
library(flextable)

fp <- fp_par(
  text.align = "center", 
  padding.bottom = 20, padding.top = 120, 
  border.bottom = fp_border())

ft <- fp_text(shading.color='#EFEFEF', 
              bold = TRUE)

source("R/functions.R")
```

```{r user input text, include = F}
year <- "Lebanon Year 1 (2016-2017)"

```

```{r user input data, include = F}
data_file_path <- "~/Box/3EA Analysis/3EA Lebanon_Analysis/Lebanon_Y1_FA/LBY1_PREIMPUTED_FULL_SPREAD_10-31-2019_mplus.dta"

subset_data <- Hmisc::Cs(
                HB1_AB_1, HB2_AB_1, HB3_AB_1, HB4_AB_1, HB5_AB_1, HB6_AB_1, 
                HB1_AD_1, HB2_AD_1, HB3_AD_1, HB4_AD_1, HB5_AD_1, HB6_AD_1, 
                HB1_SD_1, HB2_SD_1, HB3_SD_1, HB4_SD_1, HB5_SD_1, HB6_SD_1, 
                HB1_AR_1, HB2_AR_1, HB3_AR_1, HB4_AR_1, HB5_AR_1, HB6_AR_1, 
                
                HB1_AB_2, HB2_AB_2, HB3_AB_2, HB4_AB_2, HB5_AB_2, HB6_AB_2, 
                HB1_AD_2, HB2_AD_2, HB3_AD_2, HB4_AD_2, HB5_AD_2, HB6_AD_2, 
                HB1_SD_2, HB2_SD_2, HB3_SD_2, HB4_SD_2, HB5_SD_2, HB6_SD_2, 
                HB1_AR_2, HB2_AR_2, HB3_AR_2, HB4_AR_2, HB5_AR_2, HB6_AR_2,
                
                HB1_AB_3, HB2_AB_3, HB3_AB_3, HB4_AB_3, HB5_AB_3, HB6_AB_3, 
                HB1_AD_3, HB2_AD_3, HB3_AD_3, HB4_AD_3, HB5_AD_3, HB6_AD_3, 
                HB1_SD_3, HB2_SD_3, HB3_SD_3, HB4_SD_3, HB5_SD_3, HB6_SD_3, 
                HB1_AR_3, HB2_AR_3, HB3_AR_3, HB4_AR_3, HB5_AR_3, HB6_AR_3)


model_file_path <- "~/Box/For Zezhen/MR automation/Test Data"

model_cfa <- list("CS1_CFA4.out",
               "CS2_CFA4.out",
               "CS3_CFA4.out")



model_lg_inv_scalar = "CS123_CFA4_inv_scalar.out"



```

```{r data preparation, include = F}
dat <- haven::read_dta(data_file_path)

dat.s <- as.data.frame(select(dat, all_of(subset_data)))
```

\newpage

This document presents most of the features of the package `r ftext("officedown", ft)`. 
`r fp`

## Table of content

<!---BLOCK_TOC--->

## List of figures

<!---BLOCK_TOC{seq_id: 'fig'}--->

## List of tables

<!---BLOCK_TOC{seq_id: 'tab'}--->


\newpage


## Data and Sample

This report presents descriptive and psychometric information of the measures used for `r year`.

## Method

TBD...


<!---BLOCK_LANDSCAPE_START--->
## Results

### Descriptive Statistics

see Table \@ref(tab:descriptive).

```{r descriptive, tab.cap="Descriptive Statistics", tab.id = "descriptive"}
ds <- describe(dat.s) %>% 
  as.data.frame() %>%
  round(digits = 3) %>%
  rownames_to_column("variable")

flextable(ds) %>%
  align(part = "all") %>% # left align
  font(fontname = "Times", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) %>% 
  theme_booktabs() %>% # default theme
  set_table_properties(layout = "autofit")


```



<!---BLOCK_LANDSCAPE_STOP--->

see Figure \@ref(fig:ds_plot).

```{r ds_plot, fig.cap = "",fig.id = "ds_plot", fig.height = 8, fig.width = 6}

# descriptive plots

par(mfrow = c(6,6),
    mar = c(4,1,1,1))

chunk_num <- ncol(dat.s) %/% 24

while (chunk_num >= 1) {
  for (i in 1:24) {
    index <- 24*(chunk_num - 1) + i
    
    hist(dat.s[, index], main = "", xlab = names(dat.s)[index])
  }
  
  chunk_num <- chunk_num - 1
}

  
```

\newpage

### Internal Reliability and Correlations


```{r internal_reliability, tab.cap = "Internal Reliability", tab.id = "internal_reliability"}

# 4. Internal reliability ####
# (example: https://rpubs.com/hauselin/reliabilityanalysis)
alpha_stats <- alpha(dat.s)

alpha_drop <- alpha_stats$alpha.drop

flextable(alpha_drop %>% 
            round(digits = 3) %>%
            rownames_to_column("variable")) %>%
  align(part = "all") %>% # left align
  font(fontname = "Times", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) %>% 
  theme_booktabs() %>% # default theme
  set_table_properties(layout = "autofit")
```

\newpage

```{r summary_item_statistics, tab.cap = "Summary Item Statistics", tab.id = "summary_item_statistics"}
flextable(alpha_stats$item.stats %>% 
            round(digits = 3) %>%
            rownames_to_column("variable")) %>%
  align(part = "all") %>% # left align
  font(fontname = "Times", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) %>% 
  theme_booktabs() %>% # default theme
  set_table_properties(layout = "autofit")
```

\newpage

```{r item_total_statistics, tab.cap = "Item Total Statistics", tab.id = "item_total_statistics"}

flextable(alpha_stats$total %>%
            round(digits = 3) %>%
            rownames_to_column("variable")) %>%
  align(part = "all") %>% # left align
  font(fontname = "Times", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) %>% 
  theme_booktabs() %>% # default theme
  set_table_properties(layout = "autofit")

```

\newpage

<!---BLOCK_LANDSCAPE_START--->
```{r correlation_matrix, tab.cap = "Correlation Matrix", tab.id = "correlation_matrix"}
# Correlation matrix

df_cor <- get.cor(data = suppressWarnings(readModels(target = file.path(model_file_path,model_lg_inv_scalar))), 
             string = ".WITH$")

flextable(df_cor %>%
            rownames_to_column("Variable")) %>%
  align(part = "all") %>% # left align
  font(fontname = "Times", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  # add footer if you want
   add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
                  colwidths =  ncol(df_cor) + 1) %>% 
  theme_booktabs() %>% # default theme
  set_table_properties(layout = "autofit")
```

\newpage

```{r EFA screeplot, fig.height = 4, fig.width = 12}
# EFA screeplot: pending for now

# EFA <- readModels(file.path(model_file_path,"CS1_EFA.out"))
# 
# # For now, you can manually set up a spreadsheet and we can work from that spreadsheet in r
# efa <- read.csv("Eigenvector check.csv", as.is  = T)
# 
# efa$wave <- as.factor(efa$wave)
# efa$wave <- factor(efa$wave,levels(efa$wave)[c(1,3,2)])
# 
# efa.s <- filter(efa, measure == "CS")
# p <- ggplot(efa.s, aes(x = factor, y = eigenvalue)) +
#   geom_point() +
#   geom_line() +
#   scale_x_continuous(breaks = seq(0, max(efa.s$factor), by = 2)) +
#   facet_wrap(~ wave) +
#   labs(x = "\nComponent Number", y = "Eigenvalue\n", title = "Figure X. Scree plots") + theme_classic();p
```

```{r}

model_cfa <- list("CS1_CFA4.out",
               "CS2_CFA4.out",
               "CS3_CFA4.out")


df_cfa <- map_dfr(lapply(model_cfa, get.fit), bind_rows)

flextable(df_cfa) %>%
  align(part = "all") %>% # left align
  font(fontname = "Times", part = "all") %>% 
  fontsize(size = 10, part = "body") %>% 
  # add footer if you want
  # add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
  #                colwidths = 4) %>% 
  theme_booktabs() %>% # default theme
  set_table_properties(layout = "autofit")

```

<!---BLOCK_LANDSCAPE_STOP--->

## Tables

### Table 1


```{r tab.cap="caption 1", tab.id="mtcars"}
head(mtcars)
```

### Table 2

```{r tab.cap="iris"}
head(iris)
```

### Table 3

```{r tab.cap="cars", tab.id="cars"}
head(cars)
```


## figures 


### A boxplot

```{r fig.cap="A boxplot", fig.id = "boxplot"}
boxplot(1:8)
```

### A barplot

```{r fig.cap="What a barplot", fig.id = "barplot"}
barplot(1:8)
```

## Lists

Amet nunc eros curabitur tellus massa, eros maximus porttitor sociosqu, pellentesque.

* Erat mauris egestas finibus tincidunt sed in rhoncus a tellus etiam. 
    - A adipiscing per ultricies justo tellus lorem. 
        - Imperdiet ut dui primis, sed gravida, at sed nulla. 
        - Sem posuere lacus consequat inceptos dapibus duis malesuada finibus. 
    - Urna sed dui, ornare, eu turpis mus pellentesque amet amet bibendum. 
* Himenaeos tincidunt, auctor dapibus scelerisque, montes nunc faucibus 
sodales malesuada ridiculus sed cubilia ligula.


1. Erat mauris egestas finibus tincidunt sed in rhoncus a tellus etiam. 
    1. A adipiscing per ultricies justo tellus lorem. 
        1. Imperdiet ut dui primis, sed gravida, at sed nulla. 
        2. Sem posuere lacus consequat inceptos dapibus duis malesuada finibus. 
    2. Urna sed dui, ornare, eu turpis mus pellentesque amet amet bibendum. 
2. Himenaeos tincidunt, auctor dapibus scelerisque, montes nunc faucibus 
sodales malesuada ridiculus sed cubilia ligula.


Lorem dolor interdum orci eros pellentesque semper tristique, sodales, et sed
ut! Porta mattis natoque et. Ac facilisi ipsum viverra elementum vestibulum
ligula amet enim magnis luctus ullamcorper. Rhoncus rhoncus elit in at nisl.
Tincidunt habitant sit.


* Aptent conubia quam montes id sagittis.
    - Mattis nisi nascetur, aliquam duis ex, tristique.
        - Imperdiet ut dui primis, sed gravida, at sed nulla. 
        - Donec ligula nulla ac. Nisl ac at accumsan sagittis eros felis lobortis amet 
        nec phasellus urna bibendum sapien.
    - Eu dui ac id, dictum proin consectetur convallis.
* Facilisi eu lectus mauris lorem. Et sed sapien pellentesque sed etiam vehicula. 
* In porttitor id lorem eu efficitur, nisl dis!


## Reference

see figure \@ref(fig:boxplot) and table \@ref(tab:mtcars)!

