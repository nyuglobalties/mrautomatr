---
title: "`r params$set_title`"
author: "`r params$set_author`"
date: "`r Sys.Date()`"
params:
  printcode: no
  printwarning: no
  storecache: yes
  set_title: "Lebanon Year 1 (2016-2017) Measurement Report"
  set_author: "Michael Wu"
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
    reference_docx: "MR_word_template.docx"
---

```{r setup, include = F}

# knitr global settings
knitr::opts_chunk$set(echo = TRUE, 
                      fig.cap = TRUE,
                      echo = params$printcode, 
                      warning = params$printwarning, 
                      cache = params$storecache,
                      message = F,
                      error = T,
                      results="asis")

# packages
library(officedown)
library(officer)
library(tidyverse)
library(psych)
library(MplusAutomation)
library(gridExtra)
library(semPlot)
library(flextable)

fp <- fp_par(
  text.align = "center", 
  padding.bottom = 20, padding.top = 120, 
  border.bottom = fp_border())

ft <- fp_text(shading.color='#EFEFEF', 
              bold = TRUE)

# functions to generate the report
source("R/functions.R")
```

```{r user input text, include = F}
year <- "Lebanon Year 1 (2016-2017)"

```

```{r user input data, include = F}
# file path to the master dataset
data_file_path <- "~/Box/3EA Analysis/3EA Lebanon_Analysis/Lebanon_Y1_FA/LBY1_PREIMPUTED_FULL_SPREAD_10-31-2019_mplus.dta"

# a list of all items for the current construct (ordered by wave)
subset_data <- Hmisc::Cs(
                HB1_AB_1, HB2_AB_1, HB3_AB_1, HB4_AB_1, HB5_AB_1, HB6_AB_1, 
                HB1_AD_1, HB2_AD_1, HB3_AD_1, HB4_AD_1, HB5_AD_1, HB6_AD_1, 
                HB1_SD_1, HB2_SD_1, HB3_SD_1, HB4_SD_1, HB5_SD_1, HB6_SD_1, 
                HB1_AR_1, HB2_AR_1, HB3_AR_1, HB4_AR_1, HB5_AR_1, HB6_AR_1, 
                
                HB1_AB_2, HB2_AB_2, HB3_AB_2, HB4_AB_2, HB5_AB_2, HB6_AB_2, 
                HB1_AD_2, HB2_AD_2, HB3_AD_2, HB4_AD_2, HB5_AD_2, HB6_AD_2, 
                HB1_SD_2, HB2_SD_2, HB3_SD_2, HB4_SD_2, HB5_SD_2, HB6_SD_2, 
                HB1_AR_2, HB2_AR_2, HB3_AR_2, HB4_AR_2, HB5_AR_2, HB6_AR_2,
                
                HB1_AB_3, HB2_AB_3, HB3_AB_3, HB4_AB_3, HB5_AB_3, HB6_AB_3, 
                HB1_AD_3, HB2_AD_3, HB3_AD_3, HB4_AD_3, HB5_AD_3, HB6_AD_3, 
                HB1_SD_3, HB2_SD_3, HB3_SD_3, HB4_SD_3, HB5_SD_3, HB6_SD_3, 
                HB1_AR_3, HB2_AR_3, HB3_AR_3, HB4_AR_3, HB5_AR_3, HB6_AR_3)

# file path to all Mplus model outputs
model_file_path <- "~/Box/For Zezhen/MR automation/Test Data"

# a list of CFA models (ordered by wave)
model_cfa <- list("CS1_CFA4.out",
               "CS2_CFA4.out",
               "CS3_CFA4.out")



model_lg_inv_scalar = "CS123_CFA4_inv_scalar.out"



```

```{r data preparation, include = F}
# read in data (currently accepting dta, xlsx and csv)
dat <- if(grepl(".dta$", data_file_path)){
    haven::read_dta(data_file_path)
} else if(grepl(".xlsx$", data_file_path)){
  openxlsx::read.xlsx(data_file_path)
} else if(grepl(".csv$", data_file_path)){
  read_csv(data_file_path)
}

# subset of only items for the current construct
dat.s <- as.data.frame(select(dat, all_of(subset_data)))
```

\newpage

This document presents most of the features of the package `r ftext("officedown", ft)`. 
`r fp`

## Table of content

<!---BLOCK_TOC--->

## List of figures

<!---BLOCK_TOC{seq_id: 'fig'}--->

## List of tables

<!---BLOCK_TOC{seq_id: 'tab'}--->


\newpage


## Data and Sample

This report presents descriptive and psychometric information of the measures used for `r year`.

## Method

TBD...


<!---BLOCK_LANDSCAPE_START--->
## Results

### Descriptive Statistics

see Table \@ref(tab:descriptive).

```{r descriptive, tab.cap="Descriptive statistics", tab.id = "descriptive"}
ds <- skimr::skim(dat.s) %>% 
  mutate_if(is.numeric, round, 3) %>%
  select(-skim_type) %>%
  rename_with( ~ gsub("^(numeric.)(.*)$", "\\2", .x), starts_with("numeric.")) %>%
  rename(variable = skim_variable, histgram = hist)
  

flextable(ds) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>% 
  bold(part = "header") %>%
  italic(j = 6:10, part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  line_spacing(space = 1) %>%
  set_table_properties(layout = "autofit")


```



<!---BLOCK_LANDSCAPE_STOP--->


```{r ds_plot, fig.cap = "",fig.id = "ds_plot", fig.height = 8, fig.width = 6, dpi = 300}

# descriptive plots

par(mfrow = c(6,6),
    mar = c(4,1,1,1))

chunk_num <- ncol(dat.s) %/% 24

while (chunk_num >= 1) {
  for (i in 1:24) {
    index <- 24*(chunk_num - 1) + i

    hist(dat.s[, index], main = "", xlab = names(dat.s)[index], col = "white")
  }

  chunk_num <- chunk_num - 1
}

  
```

\newpage

### Internal Reliability and Correlations


```{r internal_reliability, tab.cap = "Internal reliability", tab.id = "internal_reliability"}

# 4. Internal reliability ####
# (example: https://rpubs.com/hauselin/reliabilityanalysis)
alpha_stats <- alpha(dat.s)

alpha_drop <- alpha_stats$alpha.drop

flextable(alpha_drop %>% 
            round(digits = 3) %>%
            rownames_to_column("variable")) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>% 
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")
```

\newpage

```{r summary_item_statistics, tab.cap = "Summary item statistics", tab.id = "summary_item_statistics"}
flextable(alpha_stats$item.stats %>% 
            round(digits = 3) %>%
            rownames_to_column("variable")) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")
```

\newpage

```{r item_total_statistics, tab.cap = "Item total statistics", tab.id = "item_total_statistics"}

flextable(alpha_stats$total %>%
            round(digits = 3)) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>% 
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")

```

\newpage

<!---BLOCK_LANDSCAPE_START--->
```{r correlation_matrix, tab.cap = "Correlation matrix", tab.id = "correlation_matrix"}
# Correlation matrix

df_cor <- get.cor(data = suppressWarnings(readModels(target = file.path(model_file_path,model_lg_inv_scalar))), 
             string = ".WITH$")

df_cor <- df_cor %>%
            rownames_to_column("variable") %>%
            rename(" " = variable)

flextable(df_cor) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "body") %>%
  bold(part = "header") %>%
  bold(j = " ", part = "body") %>%
  fontsize(size = 10, part = "all") %>% 
   add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
                  colwidths =  ncol(df_cor)) %>% 
  italic(part = "footer") %>%
  set_table_properties(layout = "autofit")
```

\newpage

## Factor Analysis

### EFA and CFA
```{r EFA screeplot, fig.height = 4, fig.width = 12}
# EFA screeplot: pending for now

# EFA <- readModels(file.path(model_file_path,"CS1_EFA.out"))
# 
# # For now, you can manually set up a spreadsheet and we can work from that spreadsheet in r
# efa <- read.csv("Eigenvector check.csv", as.is  = T)
# 
# efa$wave <- as.factor(efa$wave)
# efa$wave <- factor(efa$wave,levels(efa$wave)[c(1,3,2)])
# 
# efa.s <- filter(efa, measure == "CS")
# p <- ggplot(efa.s, aes(x = factor, y = eigenvalue)) +
#   geom_point() +
#   geom_line() +
#   scale_x_continuous(breaks = seq(0, max(efa.s$factor), by = 2)) +
#   facet_wrap(~ wave) +
#   labs(x = "\nComponent Number", y = "Eigenvalue\n", title = "Figure X. Scree plots") + theme_classic();p
```

```{r, cfa_model_fit, tab.cap = "CFA model fits at all waves", tab.id = "cfa_model_fit"}

df_cfa <- map_dfr(lapply(model_cfa, get.fit), bind_rows)

flextable(df_cfa) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  italic(j = 4, part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")

```

```{r, cfa_model_plot, fig.cap = "CFA model final factor structure", fig.id = "cfa_model_plot", fig.height = 4, fig.width = 8, fig.align='center', dpi = 300}

plot_label <- map_dfc(lapply(model_cfa, get.est), bind_cols) %>%
  unite("label", everything(), sep = "")

model_cfa_str <- readModels(file.path(model_file_path, model_cfa[[1]]))

par(mfrow = c(1,1))
semPaths(model_cfa_str, style="lisrel", layout = "tree",
         nCharNodes = 5, sizeMan = 4, sizeMan2 = 4, sizeLat = 8, 
         thresholds = F, residuals = F, intercepts = F, edge.color = "gray40", edgeLabels = plot_label$label, edge.label.cex = 0.3,edge.label.position = 0.8, label.cex = 1, mar=c(1,1,3,1))

```

\newpage

```{r CFA_model_parameters, tab.cap = "CFA model parameters at all waves", tab.id = "CFA_model_parameters"}
df_cfa_modparam <- lapply(model_cfa, get.modparam) %>% 
  reduce(left_join, by = c("paramHeader", "param"))

flextable(df_cfa_modparam) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")
```

\newpage

```{r cfa_r2, tab.cap = "CFA model R-squared at all waves", tab.id = "CFA_r2"}

df_cfa_r2 <- lapply(model_cfa, get.R2) %>% 
  reduce(left_join, by = c("param"))

flextable(df_cfa_r2) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")

```

<!---BLOCK_LANDSCAPE_STOP--->

### Measurement Invariance


#s
## Tables

### Table 1


```{r tab.cap="caption 1", tab.id="mtcars"}
head(mtcars)
```

### Table 2

```{r tab.cap="iris"}
head(iris)
```

### Table 3

```{r tab.cap="cars", tab.id="cars"}
head(cars)
```


## figures 


### A boxplot

```{r fig.cap="A boxplot", fig.id = "boxplot"}
boxplot(1:8)
```

### A barplot

```{r fig.cap="What a barplot", fig.id = "barplot"}
barplot(1:8)
```

## Lists

Amet nunc eros curabitur tellus massa, eros maximus porttitor sociosqu, pellentesque.

* Erat mauris egestas finibus tincidunt sed in rhoncus a tellus etiam. 
    - A adipiscing per ultricies justo tellus lorem. 
        - Imperdiet ut dui primis, sed gravida, at sed nulla. 
        - Sem posuere lacus consequat inceptos dapibus duis malesuada finibus. 
    - Urna sed dui, ornare, eu turpis mus pellentesque amet amet bibendum. 
* Himenaeos tincidunt, auctor dapibus scelerisque, montes nunc faucibus 
sodales malesuada ridiculus sed cubilia ligula.


1. Erat mauris egestas finibus tincidunt sed in rhoncus a tellus etiam. 
    1. A adipiscing per ultricies justo tellus lorem. 
        1. Imperdiet ut dui primis, sed gravida, at sed nulla. 
        2. Sem posuere lacus consequat inceptos dapibus duis malesuada finibus. 
    2. Urna sed dui, ornare, eu turpis mus pellentesque amet amet bibendum. 
2. Himenaeos tincidunt, auctor dapibus scelerisque, montes nunc faucibus 
sodales malesuada ridiculus sed cubilia ligula.


Lorem dolor interdum orci eros pellentesque semper tristique, sodales, et sed
ut! Porta mattis natoque et. Ac facilisi ipsum viverra elementum vestibulum
ligula amet enim magnis luctus ullamcorper. Rhoncus rhoncus elit in at nisl.
Tincidunt habitant sit.


* Aptent conubia quam montes id sagittis.
    - Mattis nisi nascetur, aliquam duis ex, tristique.
        - Imperdiet ut dui primis, sed gravida, at sed nulla. 
        - Donec ligula nulla ac. Nisl ac at accumsan sagittis eros felis lobortis amet 
        nec phasellus urna bibendum sapien.
    - Eu dui ac id, dictum proin consectetur convallis.
* Facilisi eu lectus mauris lorem. Et sed sapien pellentesque sed etiam vehicula. 
* In porttitor id lorem eu efficitur, nisl dis!


## Reference

see figure \@ref(fig:boxplot) and table \@ref(tab:mtcars)!

