---
title: "`r params$set_title`"
author: "`r params$set_author`"
date: "`r Sys.Date()`"
params:
  printcode: no
  printwarning: no
  storecache: no
  set_title: "Measurement Report"
  set_author: "Michael Wu"
  template: "`r mrautomatr_path('templates/input_template.xlsx')`"
  item: TRUE
  descriptive: TRUE
  ds_plot: TRUE
  correlation_matrix_lg: TRUE
  correlation_matrix_bivar: TRUE
  correlation_matrix_item: FALSE # this might crash the document, so the default is False
  efa_screeplot: TRUE
  cfa_model_fit: TRUE
  cfa_model_plot: TRUE
  cfa_model_parameters: TRUE
  cfa_r2: TRUE
  internal_reliability: TRUE
  summary_item_statistics: TRUE
  item_total_statistics: TRUE
  inv_tx: TRUE
  inv_gender: TRUE
  inv_age: TRUE
  inv_lg: TRUE
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
    reference_docx: "`r mrautomatr_path('templates/MR_word_template.docx')`"
---

```{r setup, include = F}
# knitr::opts_chunk$set(
#  collapse = TRUE,
#  comment = "#>"
#)

# knitr global settings
knitr::opts_chunk$set(
  echo = TRUE, 
  fig.cap = TRUE,
  echo = params$printcode, 
  warning = params$printwarning, 
  cache = params$storecache,
  message = F,
  error = T,
  results="asis",
  tab.cap.style = "Table Caption",
  tab.cap.pre = "Table ",
  tab.cap.sep = ": ",
  fig.cap.style = "Image Caption",
  fig.cap.pre = "Figure ",
  fig.cap.sep = ": ")

# packages
# library(officedown)
# library(officer)
# library(tidyverse)
# library(psych)
# library(MplusAutomation)
# library(semPlot)
# library(flextable)

fp <- fp_par(
  text.align = "center", 
  padding.bottom = 20, padding.top = 120, 
  border.bottom = fp_border())

ft <- fp_text(shading.color='#EFEFEF', 
              bold = TRUE)

library(mrautomatr)
```

```{r user input}
user_path <- openxlsx::read.xlsx(params$template, sheet = 1)
user_subscale <- openxlsx::read.xlsx(params$template, sheet = 2)
user_model <- openxlsx::read.xlsx(params$template, sheet = 3)
user_description <- openxlsx::read.xlsx(params$template, sheet = 4)

# using assign() to load variables as R objects
for (i in 1:length(user_path)) {
  
  assign(names(user_path)[i], user_path[,i])
  
}

# specify items for each subscale, without wave subscript (ordered by wave)
subscale_data <- BBmisc::convertColsToList(user_subscale)

  # a vector of all items for the current construct 
subset_data <- as.character(unlist(lapply(subscale_data, function(x) x[!is.na(x)])
))

# a vector of EFA models (ordered by wave)
model_efa <- na.omit(user_model$model_efa)

# a vector of CFA models (ordered by wave)
model_cfa <- na.omit(user_model$model_cfa)

# a list of treatment invariance models (config, metric and scalar; ordered by wave)
model_inv_tx <- split.list(na.omit(user_model$model_inv_tx), 3)
  
# a list of gender invariance models (config, metric and scalar; ordered by wave)
model_inv_gender <- split.list(na.omit(user_model$model_inv_gender),3)

# a list of age invariance models (config, metric and scalar; ordered by wave)
model_inv_age <- split.list(na.omit(user_model$model_inv_age),3)

# the longitudinal invariance model
model_inv_lg <- split.list(na.omit(user_model$model_inv_lg),1)
```

```{r data preparation}
# read in data (currently accepting dta, xlsx and csv)
dat <- read.any(data_file_path)

# subset of only items for the current construct
dat_s <- as.data.frame(select(dat, all_of(subset_data)))

# subscale and its corresponding item names
subscale_item_name <- as.data.frame(subscale_data) %>%
  gather(key = "subscale", value = "item") %>%
  mutate(wave = gsub("(.*)(_)(\\d+)", "\\3", subscale),
         wave = paste("T", wave, sep = ""),
         subscale = gsub("(.*)(_)(\\d+)", "\\1", subscale)) %>%
  select(subscale, wave, item) %>% 
  drop_na()

# read in factor score data (only for calculating bivariate correlation)
  if(is.null(read.any(fs_data_file_path)) == T){
    stop("Factor score data file path is not specified, please double check. Also, please make sure that the factor score dataset has the subscale names as variable names, the same as the ones specified in user_subscale.",call. = F)} else{
      dat_fs <- read.any(fs_data_file_path) %>%
  select(names(user_subscale))
    }

```

\newpage

This document is built using the package `r ftext("officedown", ft)`. 
`r fp`

## Table of content

<!---BLOCK_TOC--->

## List of figures

<!---BLOCK_TOC{seq_id: 'fig'}--->

## List of tables

<!---BLOCK_TOC{seq_id: 'tab'}--->


\newpage


## Data and Sample

This report presents descriptive and psychometric information for `r measure` in `r year`.

Table \@ref(tab:item) presents the descriptions of the items used in `r measure`.

```{r item, tab.cap="Item description", tab.id = "item", eval = params$item}

# remove the auto-created dots when reading in excel sheets
names(user_description) <- gsub("\\.", " ", names(user_description))

flextable(user_description) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>% 
  line_spacing(space = 1) %>%
  set_table_properties(layout = "autofit")
```

\newpage

## Method

TBD...

\newpage

## Results

### Descriptive Statistics

```{r descriptive, tab.cap="Descriptive statistics", tab.id = "descriptive", eval = params$descriptive}
ds <- skimr::skim(dat_s) %>% 
  mutate_if(is.numeric, round, 3) %>%
  rename_with( ~ gsub("^(numeric.)(.*)$", "\\2", .x), starts_with("numeric.")) %>%
  select(-skim_type, -hist) %>%
  rename(variable = skim_variable)
  

flextable(ds) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>% 
  bold(part = "header") %>%
  italic(j = 6:10, part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  line_spacing(space = 1) %>%
  set_table_properties(layout = "autofit")


```

\newpage
```{r ds_plot, fig.cap = "Item distribution",fig.id = "ds_plot", fig.height = 8, fig.width = 6, dpi = 300, eval = params$ds_plot}

# descriptive plots

par(mfrow = c(6,6),
    mar = c(4,1,1,1))

chunk_num <- ncol(dat_s) %/% 24

while (chunk_num >= 1) {
  for (i in 1:24) {
    index <- 24*(chunk_num - 1) + i

    hist(dat_s[, index], main = "", xlab = names(dat_s)[index], col = "white")
  }

  chunk_num <- chunk_num - 1
}

  
```

\newpage


<!---BLOCK_LANDSCAPE_START--->
```{r correlation_matrix_lg, tab.cap = "Factor correlations from the longitudinal invariance models", tab.id = "correlation_matrix_lg", eval = params$correlation_matrix_lg}
# Factor correlation matrix from longitudinal models

df_cor_lg <- sup.cat(get.cor.lg(model = model_inv_lg[3], # the third one is always the scalar model
                          path = model_file_path,
                          string = ".WITH$"))

df_cor_lg <- df_cor_lg %>%
            rownames_to_column("variable") %>%
            rename(" " = variable)

flextable(df_cor_lg) %>%
  add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
                  colwidths =  ncol(df_cor_lg)) %>%
  align(part = "all") %>% 
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  bold(j = " ", part = "body") %>%
  fontsize(size = 10, part = "all") %>% 
  italic(part = "footer") %>%
  set_table_properties(layout = "autofit")
```
\newpage

```{r correlation_matrix_bivar, tab.cap = "Bivariate correlations among factors", tab.id = "correlation_matrix_bivar", eval = params$correlation_matrix_bivar}
# Bivariate correlation matrix

df_cor_bivar <- get.cor.bivar(dat_fs)

df_cor_bivar <- df_cor_bivar %>%
            rownames_to_column("variable") %>%
            rename(" " = variable)

flextable(df_cor_bivar) %>%
  add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.", 
                  colwidths =  ncol(df_cor_bivar)) %>%
  align(part = "all") %>% 
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  bold(j = " ", part = "body") %>%
  fontsize(size = 10, part = "all") %>% 
  italic(part = "footer") %>%
  set_table_properties(layout = "autofit")
```

\newpage

```{r correlation_matrix_item, tab.cap = "Bivariate correlations among all items", tab.id = "correlation_matrix_item", eval = params$correlation_matrix_item}
# Bivariate correlation matrix among all items
# Warning!: this could be really long and takes some time to run, so the default is not to evaluate this chunk unless otherwise specified.

df_cor_item <- get.cor.bivar(dat_s)

df_cor_item <- df_cor_item %>%
            rownames_to_column("variable") %>%
            rename(" " = variable)

flextable(df_cor_item) %>%
  add_footer_row(values = "* p < 0.05. ** p < 0.01. *** p < 0.001.",
                  colwidths =  ncol(df_cor_item)) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  bold(j = " ", part = "body") %>%
  fontsize(size = 10, part = "all") %>%
  italic(part = "footer") %>%
  set_table_properties(layout = "autofit")
```

\newpage

### Factor Analysis

#### EFA and CFA
```{r efa_screeplot, fig.cap = "EFA model screeplots at all waves", fig.id = "efa_screeplot", fig.height = 4, fig.width = 9, dpi = 300, eval = params$efa_screeplot}

df_efa <- sup.cat(map_dfr(lapply(model_efa, get.eigenvalue, path = model_file_path),bind_rows))

ggplot(df_efa, aes(x = nfactor, y = ev)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(breaks = seq(0, max(df_efa$nfactor), by = 2)) +
  facet_wrap(~ wave) +
  labs(x = "\nComponent Number", y = "Eigenvalue\n") + theme_classic()
```
\newpage

```{r cfa_model_fit, tab.cap = "CFA model fits at all waves", tab.id = "cfa_model_fit", eval = params$cfa_model_fit}

df_cfa <- sup.cat(map_dfr(lapply(model_cfa, get.cfa.fit, path = model_file_path),bind_rows))

flextable(df_cfa) %>%
    compose(
    part = "header", j = "ChiSq",
    value = as_paragraph("\U03C7",as_sup("2"))
    ) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  italic(j = 4, part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")

```

\newpage
```{r cfa_model_plot, fig.cap = "CFA model final factor structure", fig.id = "cfa_model_plot", fig.height = 4, fig.width = 8, fig.align='center', dpi = 300, eval = params$cfa_model_plot}

if(length(unique(sapply(sup.cat(lapply(model_cfa, get.est, path = model_file_path)), nrow))) > 1){
  stop("The factor structure has to be the same across waves in order to draw the graph. Please check all CFA models.", call. = F)
}

plot_label <- sup.cat(map_dfc(lapply(model_cfa, get.est, path = model_file_path), bind_cols)) %>%
  unite("label", everything(), sep = "")

model_cfa_str <- sup.cat(readModels(file.path(model_file_path, model_cfa[[1]])))

par(mfrow = c(1,1))
semPaths(model_cfa_str, style="lisrel", layout = "tree",
         nCharNodes = 5, sizeMan = 4, sizeMan2 = 4, sizeLat = 8, 
         thresholds = F, residuals = F, intercepts = F, edge.color = "gray40", edgeLabels = plot_label$label, edge.label.cex = 0.3,edge.label.position = 0.8, label.cex = 1, mar=c(1,1,3,1))

```

\newpage

```{r cfa_model_parameters, tab.cap = "CFA model parameters at all waves", tab.id = "cfa_model_parameters", eval = params$cfa_model_parameters}
df_cfa_modparam <- sup.cat(lapply(model_cfa, get.modparam, path = model_file_path) %>% 
  reduce(left_join, by = c("paramHeader", "param")))

flextable(df_cfa_modparam) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")
```

\newpage

```{r cfa_r2, tab.cap = "CFA model R-squared at all waves", tab.id = "cfa_r2", eval = params$cfa_r2}

df_cfa_r2 <- sup.cat(lapply(model_cfa, get.R2, path = model_file_path)) %>% 
  reduce(left_join, by = c("param"))

flextable(df_cfa_r2) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")

```

\newpage

#### Internal Reliability and Correlations


```{r internal_reliability, tab.cap = "Internal reliability by each subscale", tab.id = "internal_reliability", eval = params$internal_reliability}

# (example: https://rpubs.com/hauselin/reliabilityanalysis)

# ## under development..
# index <- as.numeric(unique(gsub("^(.*)(\\d)$", "\\2",names(dat_s))))
# 
# alpha_list <- list()
# 
# for (i in index) {
#   
#   alpha_list[[i]] <- select(dat_s, ends_with(as.character(i)))
#   
# }
# 
# ###

alpha_drop = list()

for(i in 1:length(subscale_data)){
  
 alpha_drop[[i]] <- alpha(select(dat_s, na.omit(all_of(subscale_data[[i]]))))$alpha.drop
  
}

alpha_drop <- map_dfr(alpha_drop, bind_rows) %>% 
            round(digits = 3) %>%
            rownames_to_column("item") %>%
  left_join(subscale_item_name, by = "item") %>%
  select(subscale, wave, everything())

alpha_drop <- as_grouped_data(alpha_drop, groups = c( "wave","subscale"))


as_flextable(alpha_drop) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>% 
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")


```

\newpage

```{r summary_item_statistics, tab.cap = "Summary item statistics by each subscale", tab.id = "summary_item_statistics", eval = params$summary_item_statistics}

item_stats = list()

for(i in 1:length(subscale_data)){
  
 item_stats[[i]] <- alpha(select(dat_s, na.omit(all_of(subscale_data[[i]]))))$item.stats
  
}

item_stats <- map_dfr(item_stats, bind_rows) %>% 
            round(digits = 3) %>%
            rownames_to_column("item") %>%
  left_join(subscale_item_name, by = "item") %>%
  select(subscale, everything())

item_stats <- as_grouped_data(item_stats, groups = c( "wave","subscale"))

as_flextable(item_stats) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")
```

\newpage

```{r item_total_statistics, tab.cap = "Item total statistics", tab.id = "item_total_statistics", eval = params$item_total_statistics}

total_stats = list()

for(i in 1:length(subscale_data)){
  
 total_stats[[i]] <- alpha(select(dat_s, na.omit(all_of(subscale_data[[i]]))))$total
  
}

# a list of omega by wave
omega_by_wave_ls <- sup.cat(lapply(model_cfa, get.omega.bywave, path = model_file_path))

# add wave tag to subscale
for (i in 1:length(omega_by_wave_ls)) {
  omega_by_wave_ls[[i]]$subscale_wave <- paste(omega_by_wave_ls[[i]]$subscale_wave,
                                          i,
                                          sep = "_")
}


total_stats <- map_dfr(total_stats, bind_rows) %>% 
            round(digits = 3) %>%
            mutate(subscale_wave = unique(
              paste(subscale_item_name$subscale,
                    gsub("^(T)(\\d+)$","\\2",subscale_item_name$wave),
                    sep = "_"))
            ) %>%
  {if (is.empty(unlist(model_inv_lg)) == F) 
    left_join(.,sup.cat(get.omega.lg(model = model_inv_lg[3],
                              path = model_file_path)), 
            by = "subscale_wave") else .} %>% 
  left_join(map_dfr(omega_by_wave_ls, bind_rows),
            by = "subscale_wave") %>% # merge in omega squared 
   mutate(wave = gsub("(.*)(_)(\\d+)", "\\3", subscale_wave),
         wave = paste("T", wave, sep = ""),
         subscale = gsub("(.*)(_)(\\d+)", "\\1", subscale_wave)) %>%
  select(subscale, wave, everything(), -subscale_wave)

if(sum(is.na(total_stats$omega_lg)) > 0){
  stop("Subscales or subscale names are different in CFA and in the longitudinal invariance model. Please double check.")
}

if(sum(is.na(total_stats$omega_by_wave)) > 0){
  stop("Subscales or subscale names are different in CFA and in the input file template. Please double check.")
}

total_stats <- as_grouped_data(total_stats, groups = c( "wave"))

as_flextable(total_stats) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>% 
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  set_table_properties(layout = "autofit")

```


\newpage


#### Measurement Invariance

```{r inv_tx, tab.cap = "Treatment group invariance model fit", tab.id = "inv_tx", eval = params$inv_tx}

df_inv_tx <- sup.cat(map_dfr(lapply(model_inv_tx, get.invariance.fit, path = model_file_path), bind_rows))

df_inv_tx <- df_inv_tx %>%
  mutate(wave = gsub("^([a-zA-Z]+)(\\d+)(.*)", "\\2", Filename), .before = "Parameters") %>%
  mutate(wave = paste("T", wave, sep = ""))

df_inv_tx <- as_grouped_data(df_inv_tx, groups = c("wave"))


as_flextable(df_inv_tx) %>% 
  compose(
    part = "header", j = "ChiSqM_Value",
    value = as_paragraph("\U03C7",as_sup("2"))
    ) %>%
  compose(
    part = "header", j = "ChiSqBaseline_Value",
    value = as_paragraph("\U03C7",as_sup("2"), as_sub("B"))
    ) %>%
  compose(
    part = "header", j = "ChiSqDiffTest_Value",
    value = as_paragraph(paste("\u0394","\U03C7", sep = ""), as_sup("2"))
    ) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  italic(j = c(4,7,10), part = "header") %>%
  set_header_labels(
    Parameters = "k",
    ChiSqM_DF = "df",
    ChiSqM_PValue = "p",
    ChiSqBaseline_DF = "df",
    ChiSqBaseline_PValue = "p",
    ChiSqDiffTest_DF = "df",
    ChiSqDiffTest_PValue = "p",
    RMSEA_Estimate = "RMSEA"
  )  %>%
  set_table_properties(layout = "autofit")

```
\newpage
```{r inv_gender, tab.cap = "Gender invariance model fit", tab.id = "inv_gender", eval = params$inv_gender}

df_inv_gender <- sup.cat(map_dfr(lapply(model_inv_gender, get.invariance.fit, path = model_file_path), bind_rows))

df_inv_gender <- df_inv_gender %>%
  mutate(wave = gsub("^([a-zA-Z]+)(\\d+)(.*)", "\\2", Filename), .before = "Parameters") %>%
  mutate(wave = paste("T", wave, sep = ""))

df_inv_gender <- as_grouped_data(df_inv_gender, groups = c("wave"))

as_flextable(df_inv_gender) %>% 
  compose(
    part = "header", j = "ChiSqM_Value",
    value = as_paragraph("\U03C7",as_sup("2"))
    ) %>%
  compose(
    part = "header", j = "ChiSqBaseline_Value",
    value = as_paragraph("\U03C7",as_sup("2"), as_sub("B"))
    ) %>%
  compose(
    part = "header", j = "ChiSqDiffTest_Value",
    value = as_paragraph(paste("\u0394","\U03C7", sep = ""), as_sup("2"))
    ) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  italic(j = c(4,7,10), part = "header") %>%
  set_header_labels(
    Parameters = "k",
    ChiSqM_DF = "df",
    ChiSqM_PValue = "p",
    ChiSqBaseline_DF = "df",
    ChiSqBaseline_PValue = "p",
    ChiSqDiffTest_DF = "df",
    ChiSqDiffTest_PValue = "p",
    RMSEA_Estimate = "RMSEA"
  )  %>%
  set_table_properties(layout = "autofit")

```
\newpage
```{r inv_age, tab.cap = "Age invariance model fit", tab.id = "inv_age", eval = params$inv_age}

df_inv_age <- sup.cat(map_dfr(lapply(model_inv_age, get.invariance.fit, path = model_file_path), bind_rows))

df_inv_age <- df_inv_age %>%
  mutate(wave = gsub("^([a-zA-Z]+)(\\d+)(.*)", "\\2", Filename), .before = "Parameters") %>%
  mutate(wave = paste("T", wave, sep = ""))

df_inv_age <- as_grouped_data(df_inv_age, groups = c("wave"))

as_flextable(df_inv_age) %>% 
  compose(
    part = "header", j = "ChiSqM_Value",
    value = as_paragraph("\U03C7",as_sup("2"))
    ) %>%
  compose(
    part = "header", j = "ChiSqBaseline_Value",
    value = as_paragraph("\U03C7",as_sup("2"), as_sub("B"))
    ) %>%
  compose(
    part = "header", j = "ChiSqDiffTest_Value",
    value = as_paragraph(paste("\u0394","\U03C7", sep = ""), as_sup("2"))
    ) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  italic(j = c(4,7,10), part = "header") %>%
  set_header_labels(
    Parameters = "k",
    ChiSqM_DF = "df",
    ChiSqM_PValue = "p",
    ChiSqBaseline_DF = "df",
    ChiSqBaseline_PValue = "p",
    ChiSqDiffTest_DF = "df",
    ChiSqDiffTest_PValue = "p",
    RMSEA_Estimate = "RMSEA"
  )  %>%
  set_table_properties(layout = "autofit")

```
\newpage
```{r inv_lg, tab.cap = "Longitudinal invariance model fit", tab.id = "inv_lg", eval = params$inv_lg}

df_inv_lg <- sup.cat(get.invariance.fit(model_inv_lg, path = model_file_path))

flextable(df_inv_lg) %>% 
  compose(
    part = "header", j = "ChiSqM_Value",
    value = as_paragraph("\U03C7",as_sup("2"))
    ) %>%
  compose(
    part = "header", j = "ChiSqBaseline_Value",
    value = as_paragraph("\U03C7",as_sup("2"), as_sub("B"))
    ) %>%
  compose(
    part = "header", j = "ChiSqDiffTest_Value",
    value = as_paragraph(paste("\u0394","\U03C7", sep = ""), as_sup("2"))
    ) %>%
  align(part = "all") %>%
  font(fontname = "Times", part = "all") %>%
  bold(part = "header") %>%
  fontsize(size = 10, part = "body") %>% 
  italic(j = c(4,7,10), part = "header") %>%
  set_header_labels(
    Parameters = "k",
    ChiSqM_DF = "df",
    ChiSqM_PValue = "p",
    ChiSqBaseline_DF = "df",
    ChiSqBaseline_PValue = "p",
    ChiSqDiffTest_DF = "df",
    ChiSqDiffTest_PValue = "p",
    RMSEA_Estimate = "RMSEA"
  )  %>%
  set_table_properties(layout = "autofit")

```

<!---BLOCK_LANDSCAPE_STOP--->


## Reference

TBD...

